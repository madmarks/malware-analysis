import re
import sys

# Copyright
# =========
# Copyright (C) 2016 Trustwave Holdings, Inc.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>
#
#
# python autoit_conv_strings.py [filename] [output] by Eric Merritt 2016-07-29
#
# =Synopsis
#
# This script decodes strings in an AutoIT script that uses character by character
# string obfuscation.  This code attempts to clean up the code and make it more
# readable.  
#
# WARNING: The output of this script will not execute
#
# Input: .au3 file with encoded strings
#
# Example: python autoit_conv_strings.py malware.au3 output.txt
#


if len(sys.argv) == 2:
    output = 'output.au3'
    f_input = sys.argv[1]
elif len(sys.argv) == 3:
    output = sys.argv[2]
    f_input = sys.argv[1]
else:
    print 'usage: %s Input_file [output_file]' % sys.argv[0]
    sys.exit(1)

searchStr = 'Chr\(_2pdqycz2\(\d{1,3}\)\)[^\S\r\n]?\&*[^\S\r\n]?'

o = open(output, 'w')
f = open(f_input, 'r')


for line in f.readlines():
    matches = re.findall(searchStr, line)

    if len(matches) > 0:
        for match in matches:
            newChar = chr(int(re.search(r'\d{2,3}', match).group()) - 2)

            line = line.replace(match, newChar)

    o.write(line)
o.close()
